<ion-content>

  @if (loading) {
    <div class="loading-container">
      <ion-spinner name="crescent"></ion-spinner>
      <ion-label>Carregando ordem de serviço...</ion-label>
    </div>
  } @else if (workOrder) {
    <div class="view-container">
      <ion-segment [value]="activeTab" (ionChange)="onTabChange($event.detail.value)">
        <ion-segment-button value="details">
          <ion-label>Detalhes</ion-label>
        </ion-segment-button>
        <ion-segment-button value="tasks">
          <ion-label>Tarefas</ion-label>
        </ion-segment-button>
        <ion-segment-button value="inventory">
          <ion-label>Inventário</ion-label>
        </ion-segment-button>
      </ion-segment>
      
      <!-- Aba de Detalhes -->
      @if (activeTab === 'details') {
        <ion-card class="main-info-card">
          <ion-card-header>
            <div class="work-order-header">
              <ion-card-title class="work-order-title">Ordem de Serviço</ion-card-title>
              <div class="badges-container">
                <ion-badge [color]="getMaintenanceTypeColor(workOrder.maintenanceType)" class="type-badge">
                  {{ displayMaintenanceType(workOrder.maintenanceType) }}
                </ion-badge>
                <ion-badge [color]="getPriorityColor(workOrder.priority)" class="priority-badge">
                  {{ displayPriority(workOrder.priority) }}
                </ion-badge>
                <ion-badge [color]="getActivityStatusColor(workOrder.activityStatus)" class="status-badge">
                  {{ displayActivityStatus(workOrder.activityStatus) }}
                </ion-badge>
              </div>
            </div>
          </ion-card-header>
          
          <ion-card-content>
            <div class="description-section">
              <ion-label class="section-label">Descrição</ion-label>
              <p class="description-text">{{ workOrder.description }}</p>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Informações Básicas -->
        <ion-card class="details-card">
          <ion-card-header>
            <ion-card-title class="card-title">Informações Básicas</ion-card-title>
          </ion-card-header>
          
          <ion-card-content>
            <ion-grid class="details-grid">
              <ion-row>
                <ion-col size="12" size-md="6">
                  <div class="info-item">
                    <ion-label class="info-label">Descrição</ion-label>
                    <ion-label class="info-value">{{ workOrder.description }}</ion-label>
                  </div>
                </ion-col>
                <ion-col size="12" size-md="6">
                  <div class="info-item">
                    <ion-label class="info-label">Tipo de Manutenção</ion-label>
                    <ion-label class="info-value">{{ displayMaintenanceType(workOrder.maintenanceType) }}</ion-label>
                  </div>
                </ion-col>
              </ion-row>
              
              <ion-row>
                <ion-col size="12" size-md="6">
                  <div class="info-item">
                    <ion-label class="info-label">Prioridade</ion-label>
                    <ion-label class="info-value">{{ displayPriority(workOrder.priority) }}</ion-label>
                  </div>
                </ion-col>
                <ion-col size="12" size-md="6">
                  <div class="info-item">
                    <ion-label class="info-label">Status</ion-label>
                    <ion-label class="info-value">{{ displayActivityStatus(workOrder.activityStatus) }}</ion-label>
                  </div>
                </ion-col>
              </ion-row>

              <ion-row>
                <ion-col size="12" size-md="6">
                  <div class="info-item">
                    <ion-label class="info-label">Custo Total</ion-label>
                    <ion-label class="info-value">{{ formatCurrency(workOrder.totalCost) }}</ion-label>
                  </div>
                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-card-content>
        </ion-card>

        <!-- Datas -->
        <ion-card class="dates-card">
          <ion-card-header>
            <ion-card-title class="card-title">Datas</ion-card-title>
          </ion-card-header>
          
          <ion-card-content>
            <ion-grid class="dates-grid">
              <ion-row>
                <ion-col size="12" size-md="6">
                  <div class="info-item">
                    <ion-label class="info-label">Data de Abertura</ion-label>
                    <ion-label class="info-value">{{ formatDate(workOrder.openingDate) }}</ion-label>
                  </div>
                </ion-col>
                <ion-col size="12" size-md="6">
                  <div class="info-item">
                    <ion-label class="info-label">Data de Fechamento</ion-label>
                    <ion-label class="info-value">{{ formatDate(workOrder.closingDate) }}</ion-label>
                  </div>
                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-card-content>
        </ion-card>

        <!-- Relacionamentos -->
        <ion-card class="relations-card">
          <ion-card-header>
            <ion-card-title class="card-title">Relacionamentos</ion-card-title>
          </ion-card-header>
          
          <ion-card-content>
            <ion-grid class="relations-grid">
              <ion-row>
                <ion-col size="12" size-md="6">
                  <div class="info-item">
                    <ion-label class="info-label">Equipamento</ion-label>
                    <ion-label class="info-value">{{ equipmentName || 'Carregando...' }}</ion-label>
                  </div>
                </ion-col>
                <ion-col size="12" size-md="6">
                  <div class="info-item">
                    <ion-label class="info-label">Funcionário Responsável</ion-label>
                    <ion-label class="info-value">{{ employeeName || '-' }}</ion-label>
                  </div>
                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-card-content>
        </ion-card>

        <!-- Ações -->
        <div class="actions-container">
          <ion-button expand="block" fill="outline" (click)="onBack()" class="back-button">
            Voltar para Lista
          </ion-button>
          <ion-button expand="block" (click)="onEdit()" class="edit-button">
            Editar Ordem de Serviço
          </ion-button>
          <ion-button expand="block" color="primary" (click)="onSharePdf()">
            <ion-icon slot="start" name="document-outline"></ion-icon>
            Gerar PDF
          </ion-button>
        </div>
      }

      <!-- Aba de Tarefas -->
      @if (activeTab === 'tasks') {
        <ion-card class="tasks-card">
          <ion-card-header>
            <ion-card-title class="card-title">Tarefas Vinculadas</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            @if (loadingTasks) {
              <div class="loading-container">
                <ion-spinner name="crescent"></ion-spinner>
                <ion-label>Carregando tarefas...</ion-label>
              </div>
            } @else if (tasks.length === 0) {
              <div class="no-tasks">
                <ion-label>Nenhuma tarefa vinculada.</ion-label>
              </div>
            } @else {
              <ion-list>
                @for (task of tasks; track task.id) {
                  <ion-item lines="full">
                    <ion-label>
                      <h2>{{ task.title }}</h2>
                      <p>{{ task.description || 'Sem descrição' }}</p>
                      <div class="task-status-container">
                        <ion-badge [color]="getTaskStatusColor(task.activityStatus)">
                          {{ getTaskStatusLabel(task.activityStatus) }}
                        </ion-badge>
                        <div class="status-buttons">
                          <ion-button 
                            size="small" 
                            fill="outline"
                            color="primary"
                            [disabled]="task.activityStatus === 'COMPLETED'"
                            (click)="openStatusChangeModal(task)">
                            Alterar Status
                          </ion-button>
                        </div>
                      </div>
                    </ion-label>
                    <ion-buttons slot="end">
                      <ion-button fill="clear" size="small" (click)="viewTask(task)">
                        <ion-icon src="../../../assets/icons/eye-icon.svg" slot="icon-only"></ion-icon>
                      </ion-button>
                      <ion-button 
                        fill="clear" 
                        size="small" 
                        [disabled]="task.activityStatus === 'COMPLETED'"
                        (click)="editTask(task)">
                        <ion-icon src="../../../assets/icons/pencil-icon.svg" slot="icon-only"></ion-icon>
                      </ion-button>
                      <ion-button 
                        fill="clear" 
                        size="small" 
                        color="danger" 
                        [disabled]="task.activityStatus === 'COMPLETED'"
                        (click)="deleteTask(task)">
                        <ion-icon src="../../../assets/icons/trash-icon.svg" slot="icon-only"></ion-icon>
                      </ion-button>
                    </ion-buttons>
                  </ion-item>
                }
              </ion-list>
            }

            <!-- Ações para criar tarefas -->
            <div class="task-actions">
              <ion-button expand="block" fill="outline" (click)="openCreateTaskModal()">Adicionar Tarefas</ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      }

      <!-- Aba de Inventário -->
      @if (activeTab === 'inventory') {
        <ion-card class="inventory-card">
          <ion-card-header>
            <ion-card-title class="card-title">Itens do Inventário</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            @if (loadingInventory) {
              <div class="loading-container">
                <ion-spinner name="crescent"></ion-spinner>
                <ion-label>Carregando itens do inventário...</ion-label>
              </div>
            } @else if (inventoryItems.length === 0) {
              <div class="no-items">
                <ion-label>Nenhum item do inventário vinculado.</ion-label>
              </div>
            } @else {
              <ion-list>
                @for (item of inventoryItems; track item.inventoryId) {
                  <ion-item lines="full">
                    <ion-label>
                      <h2>{{ item.inventoryName }}</h2>
                      <p>Quantidade: {{ item.quantity }}</p>
                      <p>Custo unitário: {{ formatCurrency(item.unitCost) }}</p>
                      <p>Custo total: {{ formatCurrency(item.totalCost) }}</p>
                      <p>Data de saída: {{ formatDate(item.outputDate) }}</p>
                    </ion-label>
                    <ion-buttons slot="end">
                      <ion-button fill="clear" size="small" color="danger" (click)="removeInventoryItem(item)">
                        <ion-icon src="../../../assets/icons/trash-icon.svg" slot="icon-only"></ion-icon>
                      </ion-button>
                    </ion-buttons>
                  </ion-item>
                }
              </ion-list>
            }

            <!-- Ações para adicionar itens -->
            <div class="inventory-actions">
              <ion-button expand="block" fill="outline" (click)="openAddInventoryModal()">Adicionar Item do Inventário</ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      }

    </div>
  } @else {
    <div class="error-container">
      <ion-icon name="alert-circle" class="error-icon"></ion-icon>
      <ion-label class="error-message">Ordem de serviço não encontrada</ion-label>
      <ion-button fill="outline" (click)="onBack()" class="back-button">
        Voltar para Lista
      </ion-button>
    </div>
  }

</ion-content>