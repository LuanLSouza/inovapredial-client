<ion-content>
  <!-- Painel de Filtros -->
  <ion-card class="filter-card">
    <ion-card-header>
      <ion-card-title>Filtros</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-grid class="filter-grid">
        <ion-row class="filter-row ion-align-items-end">
          <ion-col size="12" size-lg="3">
            <ion-label class="label">Data Início</ion-label>
            <ion-input 
              type="text" 
              placeholder="DD/MM/AAAA" 
              fill="solid" 
              class="input solid"
              [(ngModel)]="startDate"
              maxlength="10"
              (ionInput)="formatDateInput($event, 'startDate')">
            </ion-input>
          </ion-col>

          <ion-col size="12" size-lg="3">
            <ion-label class="label">Data Fim</ion-label>
            <ion-input 
              type="text" 
              placeholder="DD/MM/AAAA" 
              fill="solid" 
              class="input solid"
              [(ngModel)]="endDate"
              maxlength="10"
              (ionInput)="formatDateInput($event, 'endDate')">
            </ion-input>
          </ion-col>

          <ion-col size="12" size-lg="2">
            <ion-label class="label">Equipamento</ion-label>
            <ion-select 
              placeholder="Todos os equipamentos" 
              fill="solid" 
              class="select solid"
              [(ngModel)]="selectedEquipmentId">
              @for (equipment of equipments; track equipment.id) {
                <ion-select-option [value]="equipment.id">
                  {{equipment.identification}} - {{equipment.description || 'Sem descrição'}}
                </ion-select-option>
              }
            </ion-select>
          </ion-col>

          <ion-col size="12" size-lg="2">
            <ion-label class="label">Funcionário</ion-label>
            <ion-select 
              placeholder="Todos os funcionários" 
              fill="solid" 
              class="select solid"
              [(ngModel)]="selectedEmployeeId">
              @for (employee of employees; track employee.id) {
                <ion-select-option [value]="employee.id">
                  {{employee.name}}
                </ion-select-option>
              }
            </ion-select>
          </ion-col>

          <ion-col size="12" size-lg="2">
            <ion-label class="label">Tipo de Manutenção</ion-label>
            <ion-select 
              placeholder="Todos os tipos" 
              fill="solid" 
              class="select solid"
              [(ngModel)]="selectedMaintenanceType">
              @for (option of maintenanceTypeOptions; track option.value) {
                <ion-select-option [value]="option.value">{{option.label}}</ion-select-option>
              }
            </ion-select>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="12" size-lg="6">
            <ion-button expand="block" (click)="applyFilters()" [disabled]="loading">
              Aplicar Filtros
            </ion-button>
          </ion-col>
          <ion-col size="12" size-lg="6">
            <ion-button expand="block" fill="outline" (click)="clearFilters()" [disabled]="loading">
              Limpar Filtros
            </ion-button>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  @if (noBuildingSelected) {
    <ion-card class="no-building-card">
      <ion-card-content class="ion-text-center">
        <ion-icon name="business-outline" size="large"></ion-icon>
        <h3>Seleção de Edificação Necessária</h3>
        <p>Para visualizar as métricas, é necessário selecionar uma edificação.</p>
        <ion-button (click)="showBuildingSelectionModal()" fill="solid">
          Selecionar Edificação
        </ion-button>
      </ion-card-content>
    </ion-card>
  } @else if (loading) {
    <ion-card class="loading-card">
      <ion-card-content class="ion-text-center">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Carregando métricas...</p>
      </ion-card-content>
    </ion-card>
  } @else if (metricsData) {

    <!-- Cards de Métricas Gerais -->
    <ion-card class="metrics-section">
      <ion-card-header>
        <ion-card-title>Métricas Gerais</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="12" size-md="6" size-lg="4">
              <div class="metric-card">
                <div class="metric-value">{{formatCurrency(generalMetrics?.totalCost || 0)}}</div>
                <div class="metric-label">Custo Total</div>
              </div>
            </ion-col>
            <ion-col size="12" size-md="6" size-lg="4">
              <div class="metric-card">
                <div class="metric-value">{{generalMetrics?.totalWorkOrders || 0}}</div>
                <div class="metric-label">Total de Ordens de Serviço</div>
              </div>
            </ion-col>
            <ion-col size="12" size-md="6" size-lg="4">
              <div class="metric-card">
                <div class="metric-value">{{generalMetrics?.totalTasks || 0}}</div>
                <div class="metric-label">Total de Tarefas</div>
              </div>
            </ion-col>
            <ion-col size="12" size-md="6" size-lg="4">
              <div class="metric-card">
                <div class="metric-value">{{generalMetrics?.activeEquipments || 0}}/{{generalMetrics?.totalEquipments || 0}}</div>
                <div class="metric-label">Equipamentos Ativos/Total</div>
              </div>
            </ion-col>
            <ion-col size="12" size-md="6" size-lg="4">
              <div class="metric-card">
                <div class="metric-value">{{formatCurrency(generalMetrics?.averageCostPerWorkOrder || 0)}}</div>
                <div class="metric-label">Custo Médio por OS</div>
              </div>
            </ion-col>
            <ion-col size="12" size-md="6" size-lg="4">
              <div class="metric-card">
                <div class="metric-value">{{formatCurrency(generalMetrics?.averageCostPerTask || 0)}}</div>
                <div class="metric-label">Custo Médio por Tarefa</div>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- Seção de Ordens de Serviço -->
    <ion-card class="metrics-section">
      <ion-card-header>
        <ion-card-title>Ordens de Serviço</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="12" size-md="6" size-lg="3">
              <div class="metric-card success">
                <div class="metric-value-work">{{workOrderMetrics?.completedWorkOrders || 0}}</div>
                <div class="metric-label-work">Completas</div>
              </div>
            </ion-col>
            <ion-col size="12" size-md="6" size-lg="3">
              <div class="metric-card danger">
                <div class="metric-value-work">{{workOrderMetrics?.cancelledWorkOrders || 0}}</div>
                <div class="metric-label-work">Canceladas</div>
              </div>
            </ion-col>
            <ion-col size="12" size-md="6" size-lg="3">
              <div class="metric-card warning">
                <div class="metric-value-work">{{workOrderMetrics?.inProgressWorkOrders || 0}}</div>
                <div class="metric-label-work">Em Progresso</div>
              </div>
            </ion-col>
            <ion-col size="12" size-md="6" size-lg="3">
              <div class="metric-card primary">
                <div class="metric-value-work">{{formatPercentage(workOrderMetrics?.completionRate || 0)}}</div>
                <div class="metric-label-work">Taxa de Conclusão</div>
              </div>
            </ion-col>
          </ion-row>
          
          <ion-row>
            <ion-col size="12" size-lg="6">
              <div class="chart-container">
                <h3>Distribuição por Tipo de Manutenção</h3>
                <canvas baseChart 
                  [data]="pieChartData" 
                  [options]="pieChartOptions" 
                  [type]="pieChartType">
                </canvas>
              </div>
            </ion-col>
            <ion-col size="12" size-lg="6">
              <div class="metric-summary">
                <h3>Resumo por Tipo</h3>
                <div class="summary-item">
                  <span class="summary-label">Preventiva:</span>
                  <span class="summary-value">{{workOrderMetrics?.preventive?.count || 0}} ordens</span>
                  <span class="summary-cost">{{formatCurrency(workOrderMetrics?.preventive?.totalCost || 0)}}</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Corretiva:</span>
                  <span class="summary-value">{{workOrderMetrics?.corrective?.count || 0}} ordens</span>
                  <span class="summary-cost">{{formatCurrency(workOrderMetrics?.corrective?.totalCost || 0)}}</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Preditiva:</span>
                  <span class="summary-value">{{workOrderMetrics?.predictive?.count || 0}} ordens</span>
                  <span class="summary-cost">{{formatCurrency(workOrderMetrics?.predictive?.totalCost || 0)}}</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Tempo Médio de Conclusão:</span>
                  <span class="summary-value">{{formatHours(workOrderMetrics?.averageCompletionTimeHours || 0)}}</span>
                </div>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- Seção de Séries Temporais -->
    <ion-card class="metrics-section">
      <ion-card-header>
        <ion-card-title>Séries Mensais  </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="12" size-lg="6">
              <div class="chart-container">
                <h3>Custos Mensais</h3>
                <canvas baseChart 
                  [data]="lineChartData" 
                  [options]="lineChartOptions" 
                  [type]="lineChartType">
                </canvas>
              </div>
            </ion-col>
            <ion-col size="12" size-lg="6">
              <div class="chart-container">
                <h3>Ordens de Serviço por Mês</h3>
                <canvas baseChart 
                  [data]="barChartData" 
                  [options]="barChartOptions" 
                  [type]="barChartType">
                </canvas>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- Seção de Equipamentos -->
    <ion-card class="metrics-section">
      <ion-card-header>
        <ion-card-title>Equipamentos</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="12" size-md="6" size-lg="3">
              <div class="metric-card success">
                <div class="metric-value-work">{{equipmentMetrics?.statusDistribution?.active || 0}}</div>
                <div class="metric-label-work">Ativos</div>
              </div>
            </ion-col>
            <ion-col size="12" size-md="6" size-lg="3">
              <div class="metric-card medium">
                <div class="metric-value-work">{{equipmentMetrics?.statusDistribution?.inactive || 0}}</div>
                <div class="metric-label-work">Inativos</div>
              </div>
            </ion-col>
            <ion-col size="12" size-md="6" size-lg="3">
              <div class="metric-card warning">
                <div class="metric-value-work">{{equipmentMetrics?.statusDistribution?.maintenance || 0}}</div>
                <div class="metric-label-work">Em Manutenção</div>
              </div>
            </ion-col>
            <ion-col size="12" size-md="6" size-lg="3">
              <div class="metric-card danger">
                <div class="metric-value-work">{{equipmentMetrics?.statusDistribution?.outOfService || 0}}</div>
                <div class="metric-label-work">Fora de Serviço</div>
              </div>
            </ion-col>
          </ion-row>
          
          <ion-row>
            <ion-col size="12">
              <div class="table-container">
                <h3>MTBF (Mean Time Between Failures)</h3>
                <ion-grid class="table-grid">
                  <ion-row class="table-header">
                    <ion-col class="col-name">Equipamento</ion-col>
                    <ion-col class="col-identification">Identificação</ion-col>
                    <ion-col class="col-failures">Falhas</ion-col>
                    <ion-col class="col-mtbf">MTBF (dias)</ion-col>
                    <ion-col class="col-last-failure">Última Falha</ion-col>
                    <ion-col class="col-criticality">Criticidade</ion-col>
                  </ion-row>
                  @for (equipment of equipmentMetrics?.equipmentMTBF; track equipment.equipmentId) {
                    <ion-row class="table-row">
                      <ion-col class="col-name">{{equipment.equipmentName}}</ion-col>
                      <ion-col class="col-identification">{{equipment.equipmentIdentification}}</ion-col>
                      <ion-col class="col-failures">{{equipment.failureCount}}</ion-col>
                      <ion-col class="col-mtbf">{{equipment.averageDaysBetweenFailures ? equipment.averageDaysBetweenFailures.toFixed(1) : 'N/A'}}</ion-col>
                      <ion-col class="col-last-failure">
                        {{formatLastFailureDate(equipment.lastFailureDate)}}
                      </ion-col>
                      <ion-col class="col-criticality">
                        <ion-badge [color]="getCriticalityColor(equipment.criticality)">
                          {{getCriticalityLabel(equipment.criticality)}}
                        </ion-badge>
                      </ion-col>
                    </ion-row>
                  }
                </ion-grid>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- Seção de Inventário -->
    <ion-card class="metrics-section">
      <ion-card-header>
        <ion-card-title>Inventário</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="12" size-md="6">
              <div class="metric-card">
                <div class="metric-value">{{formatCurrency(inventoryMetrics?.totalMaterialCost || 0)}}</div>
                <div class="metric-label">Custo Total de Materiais</div>
              </div>
            </ion-col>
            <ion-col size="12" size-md="6">
              <div class="metric-card">
                <div class="metric-value">{{inventoryMetrics?.totalItemsUsed || 0}}</div>
                <div class="metric-label">Total de Itens Usados</div>
              </div>
            </ion-col>
          </ion-row>
          
          <ion-row>
            <ion-col size="12" size-lg="6">
              <div class="table-container">
                <h3>Itens Mais Usados</h3>
                <ion-grid class="table-grid">
                  <ion-row class="table-header">
                    <ion-col class="col-name">Item</ion-col>
                    <ion-col class="col-type">Tipo</ion-col>
                    <ion-col class="col-quantity">Quantidade Usada</ion-col>
                    <ion-col class="col-cost">Custo Total</ion-col>
                    <ion-col class="col-stock">Estoque Atual</ion-col>
                  </ion-row>
                  @for (item of inventoryMetrics?.topUsedItems; track item.itemId) {
                    <ion-row class="table-row">
                      <ion-col class="col-name">{{item.itemName}}</ion-col>
                      <ion-col class="col-type">{{item.itemType}}</ion-col>
                      <ion-col class="col-quantity">{{item.totalQuantityUsed}}</ion-col>
                      <ion-col class="col-cost">{{formatCurrency(item.totalCost)}}</ion-col>
                      <ion-col class="col-stock">{{item.currentStock}}</ion-col>
                    </ion-row>
                  }
                </ion-grid>
              </div>
            </ion-col>
            
            <ion-col size="12" size-lg="6">
              <div class="table-container">
                <h3>Alertas de Estoque Baixo</h3>
                <ion-grid class="table-grid">
                  <ion-row class="table-header">
                    <ion-col class="col-name">Item</ion-col>
                    <ion-col class="col-type">Tipo</ion-col>
                    <ion-col class="col-current">Atual</ion-col>
                    <ion-col class="col-minimum">Mínimo</ion-col>
                    <ion-col class="col-cost">Custo Unitário</ion-col>
                  </ion-row>
                  @for (alert of inventoryMetrics?.lowStockAlerts; track alert.itemId) {
                    <ion-row class="table-row warning-row">
                      <ion-col class="col-name">{{alert.itemName}}</ion-col>
                      <ion-col class="col-type">{{alert.itemType}}</ion-col>
                      <ion-col class="col-current">{{alert.currentQuantity}}</ion-col>
                      <ion-col class="col-minimum">{{alert.minimumQuantity}}</ion-col>
                      <ion-col class="col-cost">{{formatCurrency(alert.unitCost)}}</ion-col>
                    </ion-row>
                  }
                </ion-grid>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

  } @else {
    <ion-card class="empty-card">
      <ion-card-content class="ion-text-center">
        <ion-icon name="analytics-outline" size="large"></ion-icon>
        <p>Nenhuma métrica disponível</p>
      </ion-card-content>
    </ion-card>
  }

</ion-content>
